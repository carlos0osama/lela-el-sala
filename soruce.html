<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙŠÙ„Ø© ØµÙ„Ø§Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the chosen fonts and subtle background animation */
        body {
            font-family: 'Almarai', sans-serif; /* Default font */
            background-color: #F5F5DC; /* Light beige for background */
            overflow-y: auto; /* Allow vertical scrolling */
            overflow-x: hidden; /* Hide horizontal overflow */
            min-height: 100vh; /* Ensure body takes full viewport height for scrolling */
            /* New background image styles - UPDATED TO RELATIVE PATH */
            background-image: url('1.webp'); /* Your uploaded image, now referred by its name */
            background-size: cover; /* Cover the entire body */
            background-position: center; /* Center the image */
            background-attachment: fixed; /* Keep image fixed when scrolling */
            background-repeat: no-repeat; /* Do not repeat the image */
            position: relative; /* Needed for ::before absolute positioning */
        }
        /* NEW: ::before pseudo-element for the gradient overlay */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; /* This will now cover the entire scrollable height of the body */
            background: linear-gradient(135deg, #ADD8E6 0%, #87CEEB 100%); /* Light sky blue gradient */
            opacity: 0.7;
            animation: pulse-light 8s infinite ease-in-out;
            z-index: -1; /* Place it behind the content */
        }

        .font-cairo {
            font-family: 'Cairo', sans-serif;
        }
        .bg-sky-gradient {
            /* This class is no longer applied to a div, but its properties are used in ::before */
        }
        .text-gold {
            color: #DAA520; /* Subtle gold accent */
        }
        .countdown-digit {
            font-size: 3rem; /* Large digits for mobile */
            line-height: 1;
            font-weight: 700;
        }
        .countdown-label {
            font-size: 0.9rem;
            font-weight: 400;
            color: #4A5568; /* Darker gray for labels */
        }

        /* Subtle background animation */
        @keyframes pulse-light {
            0% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.05); }
            100% { opacity: 0.4; transform: scale(1); }
        }

        .animated-background-light {
            /* This class is no longer applied to a div, but its animation is used in ::before */
        }

        /* Saint Mina SVG - simple and lightweight */
        .saint-mina-icon {
            width: 80px; /* Adjust size as needed */
            height: 80px;
            fill: #DAA520; /* Gold color for the icon */
            opacity: 0.7;
        }

        /* Hide elements initially for smooth entry */
        .fade-in-element {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInSlideUp 1s forwards;
        }

        @keyframes fadeInSlideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }

        /* Overlay for readability on top of background image */
        .content-overlay {
            background-color: rgba(255, 255, 255, 0.85); /* Semi-transparent white overlay */
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-start min-h-screen p-4">
    <!-- Removed the div for the animated background gradient. It's now handled by body::before -->

    <!-- Main Invitation Page Content -->
    <div id="main-page" class="relative z-10 p-6 md:p-8 text-center max-w-sm w-full border border-gray-200 my-8 content-overlay">
        <!-- Saint Mina Icon (simple SVG) -->
        <div class="flex justify-center mb-4">
            <svg class="saint-mina-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 2c4.41 0 8 3.59 8 8s-3.59 8-8 8-8-3.59-8-8 3.59-8 8-8zm0 2a6 6 0 100 12 6 6 0 000-12zm0 2a4 4 0 110 8 4 4 0 010-8zm0 2a2 2 100 4 2 2 0 000-4zM11 10h2v4h-2zm0 5h2v2h-2z"/>
                <!-- This is a generic cross/halo shape, not a specific detailed icon of St. Mina to keep it light -->
                <!-- For a more specific St. Mina, a custom path would be needed, but this ensures lightweight -->
                <path d="M12 7.5l-1.5 3.5-3.5 1.5 3.5 1.5 1.5 3.5 1.5-3.5 3.5-1.5-3.5-1.5z" fill="#DAA520"/>
            </svg>
        </div>

        <h1 class="text-2xl md:text-3xl font-bold mb-2 text-gray-800 fade-in-element" style="animation-delay: 0.2s;">
            Ù„ÙŠÙ„Ø© ØµÙ„Ø§Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ
        </h1>
        <p class="text-lg md:text-xl text-gray-600 mb-4 fade-in-element" style="animation-delay: 0.4s;">
            Ø¯Ø¹ÙˆØ© Ù„ÙƒÙ„ Ø´Ø¨Ø§Ø¨ ÙˆØ¨Ù†Ø§Øª Ø«Ø§Ù†ÙˆÙŠ
        </p>

        <!-- New: Bible Verse at the top -->
        <div class="text-center mb-4 fade-in-element" style="animation-delay: 0.5s;">
            <p class="text-base md:text-lg text-gray-700 font-cairo mb-1">
                "ÙÙØªÙØ¯Ù’Ø¹ÙÙˆÙ†ÙÙ†ÙÙŠ ÙˆÙØªÙØ°Ù’Ù‡ÙØ¨ÙÙˆÙ†Ù ÙˆÙØªÙØµÙÙ„ÙÙ‘ÙˆÙ†Ù Ø¥ÙÙ„ÙÙŠÙÙ‘ ÙÙØ£ÙØ³Ù’Ù…ÙØ¹Ù Ù„ÙÙƒÙÙ…Ù’."
            </p>
            <p class="text-sm text-gray-500 font-cairo">(Ø¥ÙØ±Ù’Ù…ÙÙŠÙØ§ Ù¢Ù©:â€Ù¡Ù¢)</p>
        </div>

        <div class="text-gray-700 mb-6 fade-in-element" style="animation-delay: 0.6s;">
            <p class="mb-1">
                <span class="font-bold text-gold">Ø§Ù„Ù…ÙŠØ¹Ø§Ø¯:</span> Ø§Ù„Ø¬Ù…Ø¹Ø© Ø§Ù„Ø¬Ø§ÙŠØ© 18 ÙŠÙˆÙ„ÙŠÙˆ
            </p>
            <p class="mb-1">
                <span class="font-bold text-gold">Ù…Ù†:</span> Ù¦:Ù£Ù  Ù…Ø³Ø§Ø¡Ù‹ <span class="font-bold text-gold">Ø¥Ù„Ù‰:</span> Ù¨:Ù Ù  Ù…Ø³Ø§Ø¡Ù‹
            </p>
            <p>
                <span class="font-bold text-gold">Ø§Ù„Ù…ÙƒØ§Ù†:</span> Ø§Ù„ÙƒÙ†ÙŠØ³Ø© Ø§Ù„ØµØºÙŠØ±Ø© Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ ÙƒÙ†ÙŠØ³Ø© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ†
            </p>
        </div>

        <!-- Countdown Section -->
        <div id="countdown-section" class="mb-6 fade-in-element" style="animation-delay: 0.8s;">
            <p class="text-gray-700 text-lg mb-3">ÙØ§Ø¶Ù„ Ù‚Ø¯ Ø¥ÙŠÙ‡ Ø¹Ù„Ù‰ Ù„ÙŠÙ„Ø© Ø§Ù„ØµÙ„Ø§Ø©ØŸ</p>
            <div class="flex justify-center items-center space-x-4">
                <div class="flex flex-col items-center">
                    <span id="days" class="countdown-digit text-sky-700">00</span>
                    <span class="countdown-label">ÙŠÙˆÙ…</span>
                </div>
                <div class="text-sky-700 countdown-digit">:</div>
                <div class="flex flex-col items-center">
                    <span id="hours" class="countdown-digit text-sky-700">00</span>
                    <span class="countdown-label">Ø³Ø§Ø¹Ø©</span>
                </div>
                <div class="text-sky-700 countdown-digit">:</div>
                <div class="flex flex-col items-center">
                    <span id="minutes" class="countdown-digit text-sky-700">00</span>
                    <span class="countdown-label">Ø¯Ù‚ÙŠÙ‚Ø©</span>
                </div>
                <div class="text-sky-700 countdown-digit">:</div>
                <div class="flex flex-col items-center">
                    <span id="seconds" class="countdown-digit text-sky-700">00</span>
                    <span class="countdown-label">Ø«Ø§Ù†ÙŠØ©</span>
                </div>
            </div>
        </div>

        <!-- Message after countdown ends -->
        <div id="message-section" class="hidden text-center fade-in-element" style="animation-delay: 0.2s;">
            <p class="text-2xl md:text-3xl font-bold text-gold mb-4">
                ÙŠØ§ Ø¨Ø®Øª Ø§Ù„Ù„ÙŠ ØµÙ„Ù‰ â¤ï¸â¤ï¸â¤ï¸
            </p>
            <p class="text-lg md:text-xl text-gray-700 mb-4 font-cairo">
                "Ù…ÙÙ†Ù Ù±Ù„Ø¶ÙÙ‘ÙŠÙ‚Ù Ø¯ÙØ¹ÙÙˆÙ’ØªÙ Ù±Ù„Ø±ÙÙ‘Ø¨ÙÙ‘ ÙÙØ£ÙØ¬ÙØ§Ø¨ÙÙ†ÙÙŠ Ù…ÙÙ†Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ø¨Ù."
            </p>
            <p class="text-sm text-gray-500 font-cairo">(Ø§ÙÙ„Ù’Ù…ÙØ²ÙØ§Ù…ÙÙŠØ±Ù Ù¡Ù¡Ù¨:â€Ù¥)</p>
        </div>

        <!-- RSVP Status Indicator -->
        <div id="rsvp-status" class="mt-4 hidden bg-green-100 text-green-800 py-2 px-4 rounded-lg text-lg font-bold">
            Ø£Ù†Øª Ø¬Ø§ÙŠ! ğŸ‰
        </div>

        <!-- New: RSVP Button -->
        <button id="rsvp-button" class="mt-8 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50">
            Ø£Ù†Ø§ Ø¬Ø§ÙŠØŸ (ØµÙˆØª Ù‡Ù†Ø§)
        </button>

        <!-- Share Button -->
        <button id="share-button" class="mt-4 bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50">
            Ø´Ø§Ø±Ùƒ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù…Ø¹ Ø£ØµØ­Ø§Ø¨Ùƒ
        </button>

        <!-- Removed View Summary Button from main page -->
    </div>

    <!-- Vote Page Content (Initially Hidden) -->
    <div id="vote-page" class="relative z-10 p-6 md:p-8 text-center max-w-sm w-full border border-gray-200 hidden my-8 content-overlay">
        <h2 class="text-2xl md:text-3xl font-bold mb-6 text-gray-800">
            Ù‡ØªÙŠØ¬ÙŠ Ù„ÙŠÙ„Ø© Ø§Ù„ØµÙ„Ø§Ø©ØŸ
        </h2>
        <!-- Optional Name Input -->
        <div class="mb-6">
            <label for="voter-name" class="block text-gray-700 text-lg font-bold mb-2">Ø§Ø³Ù…Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <input type="text" id="voter-name" placeholder="...." class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-sky-500 text-gray-800 text-center">
        </div>
        <div class="flex flex-col space-y-4">
            <!-- Reordered buttons -->
            <button data-vote="coming" class="vote-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                Ø¬ÙŠ
            </button>
            <button data-vote="definitely_coming" class="vote-button bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                Ø¬ÙŠ Ø£ÙƒÙŠØ¯
            </button>
            <button data-vote="not_coming" class="vote-button bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                Ù…Ø´ Ø¬ÙŠ
            </button>
        </div>
    </div>

    <!-- Vote Summary Page Content - NEWLY ADDED AND HIDDEN BY DEFAULT -->
    <div id="summary-page" class="relative z-10 p-6 md:p-8 text-center max-w-sm w-full border border-gray-200 hidden my-8 content-overlay">
        <h2 class="text-2xl md:text-3xl font-bold mb-6 text-gray-800">
            Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØµÙˆÙŠØª
        </h2>
        <div id="actual-vote-summary-display" class="bg-blue-50 text-blue-800 p-4 rounded-lg text-lg text-center shadow-inner">
            <p class="font-bold mb-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØµÙˆÙŠØªØ§Øª:</p>
            <p>Ø¬ÙŠ Ø£ÙƒÙŠØ¯: <span id="summary-definitely-coming" class="font-bold">0</span></p>
            <p>Ø¬ÙŠ: <span id="summary-coming" class="font-bold">0</span></p>
            <p>Ù…Ø´ Ø¬ÙŠ: <span id="summary-not-coming" class="font-bold">0</span></p>
            <p class="mt-2 text-sm text-gray-600">Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØªØªØ­Ø¯Ø« Ø¨Ø´ÙƒÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ.</p>
        </div>
        <button id="back-to-main-button" class="mt-8 bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50">
            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </button>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content">
            <p id="modal-message" class="text-xl font-bold text-gray-800 mb-4"></p>
            <button id="modal-close-button" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-full">ØªÙ…Ø§Ù…</button>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration - NOW HARDCODED WITH YOUR PROJECT'S CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyAMHEeVIzyIV9zWXhg99YnP9Zl3EVDD5zI",
          authDomain: "lela-el-sala.firebaseapp.com",
          projectId: "lela-el-sala",
          storageBucket: "lela-el-sala.firebasestorage.app",
          messagingSenderId: "21108424871",
          appId: "1:21108424871:web:07dd2d12e2285fff675b82",
          measurementId: "G-WHP3ZSV4CJ"
        };

        // Use projectId from firebaseConfig as appId for consistency
        const appId = firebaseConfig.projectId; // This now uses your actual projectId
        const initialAuthToken = null; // This is set to null as it's not used outside Canvas environment

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Initialize Firebase and Authenticate
        async function initializeFirebase() {
            try {
                if (firebaseConfig.apiKey && firebaseConfig.projectId) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Firebase Authenticated. User ID:", userId);
                            isAuthReady = true;
                            await loadRsvpStatus(); // Load RSVP status after auth is ready
                        } else {
                            console.log("No user signed in. Attempting anonymous sign-in.");
                            try {
                                await signInAnonymously(auth);
                            } catch (error) {
                                console.error("Firebase Auth Error:", error);
                                showCustomModal("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Authentication.");
                            }
                        }
                    });
                } else {
                    console.warn("Firebase config is incomplete. Firestore functionality will not work.");
                    showCustomModal("Ø®Ø·Ø£: Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ØºÙŠØ± ÙƒØ§Ù…Ù„Ø©. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙƒÙˆØ¯.");
                    isAuthReady = false;
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showCustomModal("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ‡ÙŠØ¦Ø© Firebase. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„.");
                isAuthReady = false;
            }
        }

        // Firestore functions
        async function saveRsvpStatus(status, name) { // Added name parameter
            if (!isAuthReady || !userId || !db) {
                console.error("Firebase not ready or user not authenticated to save RSVP.");
                showCustomModal("Ø­Ø¯Ø« Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØµÙˆÙŠØª Ø­Ø§Ù„ÙŠØ§Ù‹. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase.");
                return false;
            }
            try {
                const rsvpDocRef = doc(db, `artifacts/${appId}/users/${userId}/prayer_night_rsvp`, 'my_rsvp');
                await setDoc(rsvpDocRef, {
                    status: status,
                    name: name, // Save the name
                    timestamp: new Date().toISOString()
                });
                console.log("RSVP status saved:", status, "Name:", name);
                return true;
            } catch (e) {
                console.error("Error saving RSVP status:", e);
                showCustomModal("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØµÙˆÙŠØª. ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore.");
                return false;
            }
        }

        async function loadRsvpStatus() {
            if (!isAuthReady || !userId || !db) {
                console.warn("Firebase not ready or user not authenticated to load RSVP.");
                return null;
            }
            try {
                const rsvpDocRef = doc(db, `artifacts/${appId}/users/${userId}/prayer_night_rsvp`, 'my_rsvp');
                const docSnap = await getDoc(rsvpDocRef);
                const rsvpStatusDiv = document.getElementById('rsvp-status');
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("RSVP status loaded:", data.status, "Name:", data.name);
                    if (data.status === 'coming' || data.status === 'definitely_coming') {
                        const displayName = data.name ? `ÙŠØ§ ${data.name}` : '';
                        rsvpStatusDiv.innerHTML = `Ø£Ù†Øª Ø¬Ø§ÙŠ ${displayName}! ğŸ‰`; // Update message with name
                        rsvpStatusDiv.classList.remove('hidden');
                    } else {
                        rsvpStatusDiv.classList.add('hidden');
                    }
                    return data.status;
                } else {
                    console.log("No RSVP status found for this user.");
                    rsvpStatusDiv.classList.add('hidden');
                    return null;
                }
            } catch (e) {
                console.error("Error loading RSVP status:", e);
                showCustomModal("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØµÙˆÙŠØª. ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore.");
                return null;
            }
        }

        // Function to load and display vote summary
        async function loadVoteSummary() {
            if (!db) {
                console.warn("Firestore not initialized for vote summary.");
                return;
            }
            try {
                const summaryDocRef = doc(db, `artifacts/${appId}/public`, 'vote_summary');
                const docSnap = await getDoc(summaryDocRef);

                const summaryDefinitelyComingSpan = document.getElementById('summary-definitely-coming');
                const summaryComingSpan = document.getElementById('summary-coming');
                const summaryNotComingSpan = document.getElementById('summary-not-coming');

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("Vote Summary:", data);

                    if (summaryDefinitelyComingSpan) summaryDefinitelyComingSpan.textContent = (data.total_coming_for_sure || 0).toString();
                    if (summaryComingSpan) summaryComingSpan.textContent = (data.total_coming || 0).toString();
                    if (summaryNotComingSpan) summaryNotComingSpan.textContent = (data.total_not_coming || 0).toString();

                } else {
                    console.log("No vote summary found yet. It will appear after the first vote is processed by Cloud Function.");
                    if (summaryDefinitelyComingSpan) summaryDefinitelyComingSpan.textContent = '0';
                    if (summaryComingSpan) summaryComingSpan.textContent = '0';
                    if (summaryNotComingSpan) summaryNotComingSpan.textContent = '0';
                }
            } catch (e) {
                console.error("Error loading vote summary:", e);
                showCustomModal("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØµÙˆÙŠØª. ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore.");
            }
        }


        // UI Element References
        const targetDate = new Date('2025-07-18T18:30:00+03:00').getTime(); // 6:30 PM EEST
        const daysSpan = document.getElementById('days');
        const hoursSpan = document.getElementById('hours');
        const minutesSpan = document.getElementById('minutes');
        const secondsSpan = document.getElementById('seconds');
        const countdownSection = document.getElementById('countdown-section');
        const messageSection = document.getElementById('message-section');
        const mainPage = document.getElementById('main-page');
        const votePage = document.getElementById('vote-page');
        const summaryPage = document.getElementById('summary-page');
        const rsvpButton = document.getElementById('rsvp-button');
        const shareButton = document.getElementById('share-button');
        const viewSummaryButton = document.getElementById('view-summary-button');
        const backToMainButton = document.getElementById('back-to-main-button');
        const voteButtons = document.querySelectorAll('.vote-button');
        const voterNameInput = document.getElementById('voter-name'); // Reference to the new name input
        const customModal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close-button');

        // Countdown Logic
        function updateCountdown() {
            const now = new Date().getTime();
            const distance = targetDate - now;

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            if (daysSpan) daysSpan.textContent = String(days).padStart(2, '0');
            if (hoursSpan) hoursSpan.textContent = String(hours).padStart(2, '0');
            if (minutesSpan) minutesSpan.textContent = String(minutes).padStart(2, '0');
            if (secondsSpan) secondsSpan.textContent = String(seconds).padStart(2, '0');

            if (distance < 0) {
                clearInterval(countdownInterval);
                if (countdownSection) countdownSection.classList.add('hidden');
                if (messageSection) messageSection.classList.remove('hidden');
            }
        }

        const countdownInterval = setInterval(updateCountdown, 1000);
        updateCountdown(); // Initial call

        // Custom Modal Functions
        function showCustomModal(message) {
            modalMessage.textContent = message;
            customModal.classList.add('show');
        }

        function hideCustomModal() {
            customModal.classList.remove('show');
        }

        modalCloseButton.addEventListener('click', hideCustomModal);

        // Page Navigation
        function showPage(pageId) {
            mainPage.classList.add('hidden');
            votePage.classList.add('hidden');
            summaryPage.classList.add('hidden');
            document.getElementById(pageId).classList.remove('hidden');
        }

        // Event Listeners
        rsvpButton.addEventListener('click', () => {
            showPage('vote-page');
            // Clear name input when navigating to vote page
            if (voterNameInput) voterNameInput.value = '';
        });

        // The viewSummaryButton is now removed from HTML, so this listener is effectively unused
        // but kept in JS for potential future use or if the button is re-added programmatically.
        if (viewSummaryButton) {
            viewSummaryButton.addEventListener('click', () => {
                showPage('summary-page');
                loadVoteSummary(); // Load summary data when navigating to summary page
            });
        }

        if (backToMainButton) {
            backToMainButton.addEventListener('click', () => {
                showPage('main-page');
            });
        }

        voteButtons.forEach(button => {
            button.addEventListener('click', async (event) => {
                const vote = event.target.dataset.vote;
                let voterName = voterNameInput ? voterNameInput.value.trim() : '';

                // Generate name if not provided
                if (!voterName) {
                    voterName = `Ù…Ø¬Ù‡ÙˆÙ„ ${Math.floor(Math.random() * 10000)}`; // Generates "Ù…Ø¬Ù‡ÙˆÙ„ 12345"
                }

                const saved = await saveRsvpStatus(vote, voterName); // Pass name to save function
                if (saved) {
                    if (vote === 'coming' || vote === 'definitely_coming') {
                        showCustomModal("Ù…Ø³ØªÙ†ÙŠÙ†Ùƒ ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø© ÙŠØ§ ÙƒØ¨ÙŠØ±");
                        setTimeout(() => {
                            hideCustomModal();
                            showPage('main-page');
                            loadRsvpStatus(); // Refresh status on main page
                        }, 2000);
                    } else {
                        showCustomModal("Ù‡Ø§ Ù†ØµÙ„ÙŠÙ„Ùƒ Ù…Ø¹Ø§Ù†Ø§ ÙŠØ§ Ù…Ù„Ùƒ/Ø©"); // New wholesome message
                        // <!-- k3ro_OS --> This comment is for your reference in the code
                        setTimeout(() => {
                            hideCustomModal();
                            showPage('main-page');
                            loadRsvpStatus(); // Refresh status on main page
                        }, 2000);
                    }
                }
            });
        });

        shareButton.addEventListener('click', () => {
            const shareText = "Ù…Ø³ØªÙ†ÙŠÙŠÙ†Ùƒ ÙÙŠ Ù„ÙŠÙ„Ø© ØµÙ„Ø§Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø© 18 ÙŠÙˆÙ„ÙŠÙˆØŒ 6:30 Ù…Ø³Ø§Ø¡Ù‹ ÙÙŠ Ø§Ù„ÙƒÙ†ÙŠØ³Ø© Ø§Ù„ØµØºÙŠØ±Ø© Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ ÙƒÙ†ÙŠØ³Ø© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ†! Ù…ØªÙÙˆØªØ´ Ø§Ù„ÙØ±ØµØ© Ø¯ÙŠ â¤ï¸ #Ù„ÙŠÙ„Ø©_ØµÙ„Ø§Ø© #Ø´Ø¨Ø§Ø¨_Ø«Ø§Ù†ÙˆÙŠ";
            const shareUrl = window.location.href;

            if (navigator.share) {
                navigator.share({
                    title: 'Ù„ÙŠÙ„Ø© ØµÙ„Ø§Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ',
                    text: shareText,
                    url: shareUrl,
                }).then(() => {
                    console.log('Thanks for sharing!');
                }).catch(console.error);
            } else {
                const el = document.createElement('textarea');
                el.value = shareText + '\n' + shareUrl;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                showCustomModal('ØªÙ… Ù†Ø³Ø® ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†! ØªÙ‚Ø¯Ø± ØªØ¨Ø¹ØªÙ‡Ø§ Ù„Ø£ØµØ­Ø§Ø¨Ùƒ Ø¯Ù„ÙˆÙ‚ØªÙŠ.');
            }
        });

        // Initialize Firebase and load RSVP status on page load
        initializeFirebase().then(() => {
            // Check URL hash to potentially show summary page on load
            if (window.location.hash === '#summary') {
                showPage('summary-page');
                loadVoteSummary();
            } else {
                showPage('main-page'); // Ensure main page is shown by default
            }
        });
    </script>
</body>
</html>
